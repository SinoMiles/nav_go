# 项目概述

**项目名（示例）**：NavGo（Next.js 导航站）

**目标**：开发一个基于 Next.js 的网址导航系统，核心需求是后台可切换前端模板/风格（Theme），切换后前台即时生效。该文档为完整的功能需求和业务逻辑说明，适合直接提供给 AI 自动生成代码或作为开发规范使用。本文档仅为文字说明，不包含代码示例。

---

# 1. 范围与里程碑

**第一版（V1，MVP + 扩展功能均包含） — 必做功能**

1. 多主题管理：安装、列出、预览、激活、删除、主题配置（logo、主色、版式开关等）。
2. 前台根据当前激活主题做服务端渲染（SSR），保证 SEO 友好与首屏一致性。
3. 后台管理（Admin）：主题列表、主题切换、上传主题包、主题配置面板、预览入口。
4. 导航项管理（完整 CRUD）：分类（Category）、链接项（Link item）、排序、启用/禁用、批量导入/导出。
5. 前端首页展示：导航卡片、分类列表、站内搜索、用户收藏（基础实现）。
6. 预览机制：在后台可预览未激活主题，使用短期有效的预览令牌（token）。
7. 权限体系：管理员认证、角色与权限控制（最小包含 Admin 与 Editor）。
8. 缓存与 CDN 策略：确保主题切换后前台立即生效（含缓存清除或主题键策略）。
9. 前端用户系统（基础）：用户注册、登录、收藏管理、投稿接口（可选社交登录）。
10. 主题市场/安装：允许从受信任源安装第三方主题包并列入主题列表（含人工审核流程）。
11. 主题可视化配置：在后台提供可视化样式编辑（logo、色彩、字体、卡片样式切换），并能保存为主题配置。
12. 部署脚本与容器化支持（Dockerfile、部署说明）。

说明：与原计划相比，本版本将扩展功能提早到第一版以便快速验证产品形态与用户体验。

---

# 2. 技术栈建议

- 平台框架：Next.js（建议使用 App Router 与 Server Components 以利于 SSR）。
- 数据库：MongoDB（使用 Mongoose 或 Prisma for MongoDB，根据团队熟悉程度选择）。
- 身份认证：NextAuth 或自研基于 JWT 的鉴权机制（建议 NextAuth 便于常见社交登录扩展）。
- 存储：主题静态资源与预览图放置于公共静态存储（public 目录或对象存储 S3/OSS）。
- ORM/ODM：Mongoose 推荐用于 MongoDB 的 Schema 管理与查询封装；也可选 Prisma 的 MongoDB 支持。
- 部署：容器化（Docker）为主，支持部署到 Vercel、Fly.io、或自建 Kubernetes 集群。
- CI/CD：GitHub Actions 或 GitLab CI。

---

# 3. 项目目录结构（建议，文字说明）

- 根目录包含 Next.js 应用的标准目录（app、public、lib 等）。
- 主题目录放置在项目内的 `themes/`（开发阶段）或作为独立包/外部存储（生产可选）。每个主题为独立文件夹，包含布局组件、样式、settings 元数据与静态资源。后台上传的主题包解压后也按该规范存放。
- 后端辅助脚本与工具放在 `lib/`，如数据库访问、鉴权、主题工具函数、缓存清理工具等。

---

# 4. 数据模型（概念描述，MongoDB 文档结构示意）

- Settings 集合：存储全局站点配置，包含字段 `activeTheme`（string）与 `themeConfigs`（按主题名存储 JSON 配置）。
- Themes 集合：记录主题元信息，字段有 `name`、`title`、`description`、`previewUrl`、`version`、`installed`、`configSchema`、`createdAt` 等。
- Categories 集合：导航类别，字段 `title`、`slug`、`order`、`createdAt`。
- LinkItems 集合：链接项，字段 `title`、`url`、`description`、`iconUrl`、`categoryId`（引用）`order`、`enabled`、`createdAt`。
- Users 集合：用户信息、角色与权限、收藏列表（可嵌套或单独收藏集合）。
- PreviewTokens 集合（短期）：用于存储后台生成的预览令牌，字段 `token`、`theme`、`expiresAt`、`createdBy`。

设计说明：数据模型以文档形式存储，利用索引（如 category slug、link url、users.email）提升查询效率。对于收藏和频繁写入的用户交互数据，考虑独立集合以便水平扩展。

---

# 5. 主题模块规范（文字说明）

每个主题必须遵守统一的规范以便能被系统动态替换：

- 主题应包含：布局组件、全局样式文件、主题元数据（settings.json）与静态资源目录。主题只负责视图层呈现，不直接访问数据库或后端服务。
- 元数据内需描述主题名、可配置项（如 logo、主色）、预览图路径及版本号。
- 主题应接受由上层传入的数据（如导航数据、siteConfig），并在其界面中渲染 children 内容与插槽位置。

安全注意：上传的主题包必须经过文件类型与路径校验，禁止执行上传包中的任意未审核脚本。

---

# 6. 核心实现思路（业务逻辑说明，无代码）

1. 根布局（服务器端）在处理每次请求时读取 Settings 中的 `activeTheme`，并基于白名单校验选择对应主题。系统通过服务器端动态加载该主题的视图组件与样式，然后把导航数据、站点配置信息作为上下文传入主题进行渲染，从而保证首屏与 SEO 一致性。

2. 后台主题切换流程：管理员在后台发起“使用该主题”的请求，系统先验证管理员权限，再写入 Settings.activeTheme 字段，同时触发缓存清除或更新策略，返回成功。前端收到成功后刷新页面，用户将看到新主题渲染结果。

3. 预览机制：管理员在后台申请短期预览令牌，系统生成并保存该令牌并返回。管理员打开带有 theme 与 token 的预览页面，服务器验证 token 后在该请求上下文使用 query 指定的主题进行临时渲染，且不更改数据库的 activeTheme。

4. 主题安装流程：上传主题包后，后端解压并校验主题结构与元数据，若通过安全与合规校验，则写入 Themes 集合并把静态资源放置到受控目录或对象存储，管理员可选择安装并激活。

5. 缓存策略：需保证主题切换后缓存失效或缓存 key 包含 theme 标识。初期为了简化可采用 SSR 并禁用持久化静态缓存，后续再按需优化并实现 CDN 清理。

---

# 7. 管理后台（Admin）业务流程说明

- 主题管理界面：展示已安装主题、在线主题源（可选）、预览与激活操作、配置按钮（打开可视化设置面板或简单配置表单）、上传/删除按钮。
- 主题切换：管理员点击“使用” -> 后端接口验证权限并设置 activeTheme -> 返回成功 -> 前端刷新/触发 revalidation。
- 主题上传：管理员上传主题压缩包 -> 后端解压校验文件结构与元数据 -> 若通过则将主题加入 Themes 列表并保存资源 -> 管理员可选择安装/激活。
- 主题可视化配置：管理员在配置面板修改 logo、色彩等 -> 系统把配置保存到 Settings 或 Theme-specific 配置字段 -> 前端渲染时读取并应用。
- 预览：管理员点击“预览” -> 后端生成短期 token -> 打开预览页面（含 token）进行临时渲染。

---

# 8. API 设计（接口说明，描述性）

公共接口（无需鉴权）示例：
- 列出已安装主题及元信息。
- 获取首页导航数据（categories + links），支持分页与排序。

管理员接口（需要鉴权）示例：
- 列出所有主题（已安装 / 可安装）。
- 激活主题（设置 activeTheme）。
- 上传主题包并安装（含校验返回安装结果）。
- 生成预览 token（短期且可配置有效期）。
- 清理缓存或触发 CDN 清除（如已集成）。
- 导航分类与链接的 CRUD 接口（含批量操作）。
- 用户管理接口（列出用户、赋权、禁用等）。

接口要点：所有管理员级接口必须做权限校验与操作审计，上传接口需要严格的文件与内容校验。

---

# 9. 前端页面与组件（职责说明）

- 首页：由当前主题的布局渲染，主题内负责卡片样式与布局，但数据（导航、分类、用户信息）由上层页面注入。
- Preview 页面：用于管理员预览主题，后端在该页面上下文以 query 参数优先使用指定主题渲染。
- Admin - 主题管理：展示主题列表、预览、激活、上传与配置入口。
- Admin - 导航管理：分类与链接的管理界面，提供排序、启用/禁用、批量导入/导出。
- 公共组件：站点头部、底部、搜索组件、分页组件、收藏按钮（前端逻辑与后端接口联动）。

---

# 10. 安全性与权限控制（文字说明）

- 高权限操作（激活主题、上传主题、清缓存）必须进行管理员身份验证与授权检查。
- 主题上传必须进行严格的文件类型、目录结构与内容白名单校验，禁止执行或自动运行上传包中的脚本。
- 预览令牌必须短期有效、记录使用者信息与来源 IP，且一旦被滥用可立即废弃。
- 对外接口要做速率限制、防注入与输入校验，敏感路径要防止路径穿越攻击。

---

# 11. 缓存策略与 CDN（文字说明）

- 初期建议以 SSR 为主并关闭长时间静态缓存，避免首次版本过于复杂。将来需要性能优化时：
  - 在页面缓存 key 中加入 theme 标识（例如 pagePath + themeName），确保不同主题的缓存不会互相覆盖。
  - 切换主题操作应触发页面 revalidation 或向 CDN 发起清除请求。

---

# 12. 测试策略（说明）

- 功能测试：验证主题切换、预览、上传、导航 CRUD、用户收藏等功能的正确性。
- 安全测试：模拟未授权访问、上传恶意包、路径穿越尝试与速率限制检测。
- 集成测试：在部署环境中验证 SSR 渲染与主题加载的一致性，确保无 hydration mismatch。
- 性能测试：当导航项数量大时测试首页渲染时间、数据库查询效率与分页性能。

---

# 13. 部署建议（文字说明）

- 环境变量包含：MongoDB 连接字符串、JWT/NextAuth Secret、管理员账号配置、对象存储密钥（若使用）、CDN 清理凭证（若有）。
- 采用容器化部署（Docker），并在 CI 中执行构建与测试步骤。
- 主题静态资源需保证在构建/部署流程中正确同步到公共目录或对象存储，并与 Themes 集合记录的路径一致。

---

# 14. 交付物与验收标准（文字说明）

交付物：可运行的 Next.js 项目（含两个示例主题）、MongoDB schema 说明、Admin UI、部署说明文档与测试用例。

验收标准：
- 管理员能通过后台切换主题，前端首页 SSR 渲染正确且立即显示新主题。
- 能生成并使用预览令牌进行临时主题预览而不改变数据库状态。
- 导航分类与链接能做完整 CRUD，前端展示正确且支持搜索与分页。
- 上传主题后经过校验能被安装并列入主题列表，激活生效。
- 权限校验与安全防护通过基本安全测试。

---

# 15. 开发任务拆解（Sprint 列表，按优先级，文字说明）

Sprint 1（初始化与核心，3-6 天）
- 初始化 Next.js 项目，配置 MongoDB 连接与基本用户模型。
- 实现 Settings 与 Themes 的数据模型与存取接口。
- 实现 Root Layout 的主题加载思路（服务器端按 activeTheme 渲染）。
- 提供两个示例主题并验证切换生效。

Sprint 2（后台与导航管理，3-6 天）
- 实现 Admin UI：主题列表、激活、预览入口、上传主题接口的后端处理。
- 实现导航分类与链接的 CRUD 接口与管理页面。
- 实现预览令牌生成与验证逻辑。

Sprint 3（完善用户与可视化配置，3-6 天）
- 实现用户注册/登录与收藏功能。
- 实现主题可视化配置面板并保存配置到 Settings。
- 实现主题市场安装的基本流程与安全审核机制。

Sprint 4（测试、优化与部署，2-4 天）
- 编写集成与安全测试用例，执行性能测试。
- 优化缓存策略与部署脚本，完成容器化与 CI 配置。

---

# 16. 风险与缓解措施（文字说明）

- 主题上传安全风险：缓解措施是严格的文件校验、人工审核与沙箱测试环境。
- 动态加载导致构建体积或一致性问题：缓解为主题资源外部托管或将视觉配置参数化为 CSS 变量并减少完整主题数量。
- 缓存失效问题导致切换延迟：在切换主题时触发页面 revalidation 或 CDN 清理，并确保缓存 key 内包含 theme 标识。

---

# 17. 最后 — 提供给 AI 的输入要点

如果你要把本文档直接交给 AI 去生成代码，请同时提供：
- 你希望使用的鉴权方案（NextAuth 或 简单 JWT）
- 是否需要社交登录（如微信/QQ/GitHub）以及是否已有第三方凭证
- 主题示例设计稿或预览图（至少两个）
- 目标部署平台（Vercel / 自建 Docker）


*文档结束 — 已去除代码示例，数据库已切换为 MongoDB，扩展功能并入第一版开发。*


数据库信息

名称 NavGo
用户名 NavGo
密码 3afnijdxHaMrJHsT
地址 39.98.161.189